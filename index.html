<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frames Vizag - Admin Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --success-color: #27ae60;
      --warning-color: #f39c12;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background-color: #f8f9fa;
    }
    
    .navbar-brand {
      font-weight: bold;
      color: var(--accent-color) !important;
    }
    
    .card {
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    
    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-approved { background-color: #d1ecf1; color: #0c5460; }
    .status-confirmed { background-color: #d4edda; color: #155724; }
    .status-delivered { background-color: #d4edda; color: #155724; }
    .status-cancelled { background-color: #f8d7da; color: #721c24; }
    
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .login-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      overflow: hidden;
      width: 400px;
    }
  </style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage" class="login-container">
  <div class="login-card">
    <div class="p-4">
      <div class="text-center mb-4">
        <i class="bi bi-shield-lock" style="font-size: 3rem; color: var(--primary-color);"></i>
        <h3 class="mt-2">Frames Vizag Admin</h3>
      </div>
      <form id="loginForm" onsubmit="login(event)">
        <div class="mb-3">
          <label class="form-label">Email Address</label>
          <input type="email" id="loginEmail" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" id="loginPassword" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary w-100 mb-3">Login</button>
      </form>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden">
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-shield-lock"></i> Frames Vizag Admin
      </a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3">Welcome, <span id="userName">Admin</span></span>
        <button class="btn btn-outline-light" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mt-4">
    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="adminTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#dashboardTab">
          <i class="bi bi-speedometer2"></i> Dashboard
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#ordersTab">
          <i class="bi bi-bag-check"></i> Orders
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#productsTab">
          <i class="bi bi-grid"></i> Products
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#retailersTab">
          <i class="bi bi-people"></i> Retailers
        </a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Dashboard Tab -->
      <div class="tab-pane fade show active" id="dashboardTab">
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card text-white bg-primary">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="bi bi-currency-rupee fs-1 me-3"></i>
                  <div>
                    <h5 class="card-title">Today's Sales</h5>
                    <h2 id="todaySales">₹0</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-success">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="bi bi-bag-check fs-1 me-3"></i>
                  <div>
                    <h5 class="card-title">Total Orders</h5>
                    <h2 id="totalOrders">0</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-warning">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="bi bi-people fs-1 me-3"></i>
                  <div>
                    <h5 class="card-title">Total Retailers</h5>
                    <h2 id="totalRetailers">0</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-info">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="bi bi-box-seam fs-1 me-3"></i>
                  <div>
                    <h5 class="card-title">Total Products</h5>
                    <h2 id="totalProducts">0</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Recent Orders</h5>
              </div>
              <div class="card-body">
                <div id="recentOrders">
                  <!-- Recent orders will be loaded here -->
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Pending Approvals</h5>
              </div>
              <div class="card-body">
                <div id="pendingRetailers">
                  <!-- Pending retailers will be loaded here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Orders Tab -->
      <div class="tab-pane fade" id="ordersTab">
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card text-white bg-primary">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="bi bi-clock fs-1 me-3"></i>
                  <div>
                    <h5 class="card-title">Pending</h5>
                    <h2 id="pendingOrders">0</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-info">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="bi bi-check fs-1 me-3"></i>
                  <div>
                    <h5 class="card-title">Confirmed</h5>
                    <h2 id="confirmedOrders">0</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-success">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="bi bi-truck fs-1 me-3"></i>
                  <div>
                    <h5 class="card-title">Delivered</h5>
                    <h2 id="deliveredOrders">0</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-danger">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="bi bi-x-circle fs-1 me-3"></i>
                  <div>
                    <h5 class="card-title">Cancelled</h5>
                    <h2 id="cancelledOrders">0</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">All Orders</h5>
          </div>
          <div class="card-body">
            <div id="ordersList">
              <!-- Orders will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Products Tab -->
      <div class="tab-pane fade" id="productsTab">
        <div class="row mb-4">
          <div class="col-md-6">
            <button class="btn btn-primary" onclick="showAddProductModal()">
              <i class="bi bi-plus-circle"></i> Add New Product
            </button>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" id="productSearch" class="form-control" placeholder="Search products..." onkeyup="filterProducts()">
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Product Inventory</h5>
          </div>
          <div class="card-body">
            <div id="productsList">
              <!-- Products will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Retailers Tab -->
      <div class="tab-pane fade" id="retailersTab">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card text-white bg-primary">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="bi bi-people fs-1 me-3"></i>
                  <div>
                    <h5 class="card-title">Total Retailers</h5>
                    <h2 id="retailersTotal">0</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-warning">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="bi bi-clock fs-1 me-3"></i>
                  <div>
                    <h5 class="card-title">Pending Approval</h5>
                    <h2 id="retailersPending">0</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-success">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="bi bi-check-circle fs-1 me-3"></i>
                  <div>
                    <h5 class="card-title">Approved</h5>
                    <h2 id="retailersApproved">0</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Retailer Management</h5>
          </div>
          <div class="card-body">
            <div id="retailersList">
              <!-- Retailers will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="productForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Product Name</label>
              <input type="text" id="productName" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Size</label>
              <input type="text" id="productSize" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">MRP</label>
              <input type="number" id="productMRP" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Selling Price</label>
              <input type="number" id="productPrice" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Category</label>
              <select id="productCategory" class="form-select" required>
                <option value="Wooden">Wooden Frame</option>
                <option value="Acrylic">Acrylic Frame</option>
                <option value="Mount">Mount Frame</option>
                <option value="Special">Special Frame</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Stock Quantity</label>
              <input type="number" id="productStock" class="form-control" required>
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">Description</label>
              <textarea id="productDescription" class="form-control" rows="3" required></textarea>
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">Image URL</label>
              <input type="url" id="productImage" class="form-control" required>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Firebase SDK -->
<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { 
    getAuth, 
    signInWithEmailAndPassword, 
    signOut,
    onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { 
    getFirestore,
    collection,
    doc,
    setDoc,
    getDoc,
    addDoc,
    updateDoc,
    query,
    where,
    orderBy,
    getDocs,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyA6ShFd_7VAHtkRUg9k6YEvNSXqKMRvuic",
    authDomain: "framesvizag.firebaseapp.com",
    projectId: "framesvizag",
    storageBucket: "framesvizag.firebasestorage.app",
    messagingSenderId: "128117311675",
    appId: "1:128117311675:web:8a817b1efb0c0e7bfb419e",
    measurementId: "G-0EKRGC9748"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Global variables
  let currentUser = null;

  // Initialize app
  function initApp() {
    // Check if user is logged in and is admin
    onAuthStateChanged(auth, (user) => {
      if (user && user.email === 'admin@gantasolutions.com') {
        currentUser = user;
        showMainApp();
        loadDashboard();
        loadOrders();
        loadProducts();
        loadRetailers();
      } else {
        showLoginPage();
      }
    });
  }

  // Show/Hide pages
  function showLoginPage() {
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
  }

  function showMainApp() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
  }

  // Authentication functions
  async function login(event) {
    event.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      currentUser = userCredential.user;
      
      // Verify admin email
      if (currentUser.email !== 'admin@gantasolutions.com') {
        alert('Only admin@gantasolutions.com can access this portal');
        await signOut(auth);
        return;
      }
      
      showMainApp();
    } catch (error) {
      alert('Login failed: ' + error.message);
    }
  }

  async function logout() {
    await signOut(auth);
    currentUser = null;
    showLoginPage();
  }

  // Dashboard functions
  async function loadDashboard() {
    try {
      // Get today's date at midnight
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Query for today's orders
      const ordersQuery = query(
        collection(db, 'orders'),
        where('createdAt', '>=', today),
        where('status', '!=', 'cancelled')
      );
      
      const ordersSnapshot = await getDocs(ordersQuery);
      let todaySales = 0;
      ordersSnapshot.forEach(doc => {
        todaySales += doc.data().total || 0;
      });
      
      document.getElementById('todaySales').textContent = `₹${todaySales.toFixed(2)}`;
      
      // Load recent orders (last 5)
      const recentOrdersQuery = query(
        collection(db, 'orders'),
        orderBy('createdAt', 'desc'),
        limit(5)
      );
      
      const recentOrdersSnapshot = await getDocs(recentOrdersQuery);
      const recentOrdersList = document.getElementById('recentOrders');
      recentOrdersList.innerHTML = '';
      
      if (recentOrdersSnapshot.empty) {
        recentOrdersList.innerHTML = '<p class="text-muted">No recent orders</p>';
      } else {
        recentOrdersSnapshot.forEach(doc => {
          const order = doc.data();
          const orderItem = document.createElement('div');
          orderItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border-bottom';
          orderItem.innerHTML = `
            <div>
              <h6 class="mb-0">Order #${order.invoiceNumber}</h6>
              <small class="text-muted">${order.createdAt?.toDate().toLocaleDateString() || 'N/A'}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold">₹${order.total.toFixed(2)}</div>
              <span class="badge ${getStatusClass(order.status)}">${order.status}</span>
            </div>
          `;
          recentOrdersList.appendChild(orderItem);
        });
      }
      
      // Load pending retailers (last 5)
      const pendingRetailersQuery = query(
        collection(db, 'retailers'),
        where('isApproved', '==', false),
        orderBy('createdAt', 'desc'),
        limit(5)
      );
      
      const pendingRetailersSnapshot = await getDocs(pendingRetailersQuery);
      const pendingRetailersList = document.getElementById('pendingRetailers');
      pendingRetailersList.innerHTML = '';
      
      if (pendingRetailersSnapshot.empty) {
        pendingRetailersList.innerHTML = '<p class="text-muted">No pending retailer approvals</p>';
      } else {
        pendingRetailersSnapshot.forEach(doc => {
          const retailer = doc.data();
          const retailerItem = document.createElement('div');
          retailerItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border-bottom';
          retailerItem.innerHTML = `
            <div>
              <h6 class="mb-0">${retailer.businessName}</h6>
              <small class="text-muted">${retailer.ownerName}</small>
            </div>
            <div>
              <button class="btn btn-sm btn-success me-1" onclick="approveRetailer('${doc.id}')">Approve</button>
              <button class="btn btn-sm btn-danger" onclick="rejectRetailer('${doc.id}')">Reject</button>
            </div>
          `;
          pendingRetailersList.appendChild(retailerItem);
        });
      }
      
      // Update counters
      const totalOrders = await getCount(collection(db, 'orders'));
      document.getElementById('totalOrders').textContent = totalOrders;
      
      const totalRetailers = await getCount(collection(db, 'retailers'));
      document.getElementById('totalRetailers').textContent = totalRetailers;
      
      const totalProducts = await getCount(collection(db, 'products'));
      document.getElementById('totalProducts').textContent = totalProducts;
      
    } catch (error) {
      console.error('Error loading dashboard:', error);
    }
  }

  async function getCount(colRef) {
    const snapshot = await getDocs(colRef);
    return snapshot.size;
  }

  function getStatusClass(status) {
    switch(status) {
      case 'pending': return 'status-pending';
      case 'confirmed': return 'status-confirmed';
      case 'delivered': return 'status-delivered';
      case 'cancelled': return 'status-cancelled';
      default: return 'bg-secondary';
    }
  }

  // Orders functions
  async function loadOrders() {
    try {
      const q = query(collection(db, 'orders'), orderBy('createdAt', 'desc'));
      const querySnapshot = await getDocs(q);
      
      let pendingOrders = 0;
      let confirmedOrders = 0;
      let deliveredOrders = 0;
      let cancelledOrders = 0;
      
      const ordersList = document.getElementById('ordersList');
      ordersList.innerHTML = '';

      if (querySnapshot.empty) {
        ordersList.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-bag-x" style="font-size: 3rem; color: #ccc;"></i>
            <h5 class="mt-3">No orders yet</h5>
            <p class="text-muted">Orders will appear here once placed.</p>
          </div>
        `;
      } else {
        querySnapshot.forEach(doc => {
          const order = { id: doc.id, ...doc.data() };
          
          switch (order.status) {
            case 'pending': pendingOrders++; break;
            case 'confirmed': confirmedOrders++; break;
            case 'delivered': deliveredOrders++; break;
            case 'cancelled': cancelledOrders++; break;
          }
          
          const orderCard = createOrderCard(order);
          ordersList.appendChild(orderCard);
        });
      }

      // Update counters
      document.getElementById('pendingOrders').textContent = pendingOrders;
      document.getElementById('confirmedOrders').textContent = confirmedOrders;
      document.getElementById('deliveredOrders').textContent = deliveredOrders;
      document.getElementById('cancelledOrders').textContent = cancelledOrders;

    } catch (error) {
      console.error('Error loading orders:', error);
    }
  }

  function createOrderCard(order) {
    const div = document.createElement('div');
    div.className = 'card mb-3';
    
    const statusClass = `status-${order.status}`;
    const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
    
    div.innerHTML = `
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Order #${order.invoiceNumber}</h6>
        <span class="badge ${statusClass}">${statusText}</span>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p class="mb-2"><strong>Customer:</strong> ${order.customerName}</p>
            <p class="mb-2"><strong>Email:</strong> ${order.customerEmail}</p>
            <p class="mb-2"><strong>Phone:</strong> ${order.customerPhone}</p>
            <p class="mb-2"><strong>Date:</strong> ${order.createdAt?.toDate().toLocaleDateString() || 'N/A'}</p>
          </div>
          <div class="col-md-6">
            <p class="mb-2"><strong>Items:</strong> ${order.items.length} products</p>
            <p class="mb-2"><strong>Quantity:</strong> ${order.items.reduce((sum, item) => sum + item.quantity, 0)} units</p>
            <p class="mb-2"><strong>Total:</strong> ₹${order.total.toFixed(2)}</p>
          </div>
        </div>
        
        <div class="mt-3">
          ${order.status === 'pending' ? `
            <button class="btn btn-success me-2" onclick="confirmOrder('${order.id}')">
              <i class="bi bi-check-circle"></i> Confirm Order
            </button>
            <button class="btn btn-danger" onclick="cancelOrder('${order.id}')">
              <i class="bi bi-x-circle"></i> Cancel Order
            </button>
          ` : ''}
          
          ${order.status === 'confirmed' ? `
            <button class="btn btn-primary me-2" onclick="markDelivered('${order.id}')">
              <i class="bi bi-truck"></i> Mark as Delivered
            </button>
          ` : ''}
          
          <button class="btn btn-outline-primary" onclick="viewOrderDetails('${order.id}', ${JSON.stringify(order).replace(/"/g, '&quot;')})">
            <i class="bi bi-eye"></i> View Details
          </button>
        </div>
      </div>
    `;
    
    return div;
  }

  async function confirmOrder(orderId) {
    if (confirm('Are you sure you want to confirm this order?')) {
      try {
        await updateDoc(doc(db, 'orders', orderId), {
          status: 'confirmed',
          confirmedAt: serverTimestamp()
        });
        alert('Order confirmed successfully!');
        loadOrders();
        loadDashboard();
      } catch (error) {
        console.error('Error confirming order:', error);
        alert('Failed to confirm order. Please try again.');
      }
    }
  }

  async function cancelOrder(orderId) {
    if (confirm('Are you sure you want to cancel this order?')) {
      try {
        await updateDoc(doc(db, 'orders', orderId), {
          status: 'cancelled',
          cancelledAt: serverTimestamp()
        });
        alert('Order cancelled.');
        loadOrders();
        loadDashboard();
      } catch (error) {
        console.error('Error cancelling order:', error);
        alert('Failed to cancel order. Please try again.');
      }
    }
  }

  async function markDelivered(orderId) {
    if (confirm('Are you sure you want to mark this order as delivered?')) {
      try {
        await updateDoc(doc(db, 'orders', orderId), {
          status: 'delivered',
          deliveredAt: serverTimestamp()
        });
        alert('Order marked as delivered!');
        loadOrders();
        loadDashboard();
      } catch (error) {
        console.error('Error marking order as delivered:', error);
        alert('Failed to update order status. Please try again.');
      }
    }
  }

  function viewOrderDetails(orderId, orderData) {
    const order = typeof orderData === 'string' ? JSON.parse(orderData) : orderData;
    
    const detailWindow = window.open('', '', 'width=800,height=600');
    const detailHTML = `
      <html>
        <head>
          <title>Order Details - ${order.invoiceNumber}</title>
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
          <style>
            body { padding: 20px; }
            .company-header { text-align: center; margin-bottom: 30px; }
            .company-name { font-size: 24px; font-weight: bold; color: #2c3e50; }
          </style>
        </head>
        <body>
          <div class="company-header">
            <div class="company-name">Frames Vizag</div>
            <p>Order Details</p>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <h5>Order Information</h5>
              <p><strong>Order Number:</strong> ${order.invoiceNumber}</p>
              <p><strong>Date:</strong> ${order.createdAt?.toDate().toLocaleDateString() || 'N/A'}</p>
              <p><strong>Status:</strong> ${order.status.toUpperCase()}</p>
            </div>
            <div class="col-md-6">
              <h5>Customer Information</h5>
              <p><strong>Name:</strong> ${order.customerName}</p>
              <p><strong>Email:</strong> ${order.customerEmail}</p>
              <p><strong>Phone:</strong> ${order.customerPhone}</p>
              <p><strong>Address:</strong> ${order.customerAddress}</p>
            </div>
          </div>
          
          <h5 class="mt-4">Order Items</h5>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Product</th>
                <th>Size</th>
                <th>Quantity</th>
                <th>Rate (₹)</th>
                <th>Amount (₹)</th>
              </tr>
            </thead>
            <tbody>
              ${order.items.map(item => `
                <tr>
                  <td>${item.name}</td>
                  <td>${item.size}</td>
                  <td>${item.quantity}</td>
                  <td>${item.price.toFixed(2)}</td>
                  <td>${(item.price * item.quantity).toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          <div class="text-end mt-4">
            <p>Subtotal: ₹${order.subtotal.toFixed(2)}</p>
            <p>Shipping: ₹${order.shipping.toFixed(2)}</p>
            <h5>Total: ₹${order.total.toFixed(2)}</h5>
          </div>
          
          <div class="text-center mt-4">
            <button class="btn btn-primary" onclick="window.print()">Print</button>
            <button class="btn btn-secondary ms-2" onclick="window.close()">Close</button>
          </div>
        </body>
      </html>
    `;
    
    detailWindow.document.write(detailHTML);
    detailWindow.document.close();
  }

  // Products functions
  async function loadProducts() {
    try {
      const q = query(collection(db, 'products'), orderBy('name'));
      const querySnapshot = await getDocs(q);
      
      const productsList = document.getElementById('productsList');
      productsList.innerHTML = '';

      if (querySnapshot.empty) {
        productsList.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-grid" style="font-size: 3rem; color: #ccc;"></i>
            <h5 class="mt-3">No products yet</h5>
            <p class="text-muted">Add products to see them listed here.</p>
          </div>
        `;
      } else {
        querySnapshot.forEach(doc => {
          const product = { id: doc.id, ...doc.data() };
          const productCard = createProductCard(product);
          productsList.appendChild(productCard);
        });
      }
    } catch (error) {
      console.error('Error loading products:', error);
    }
  }

  function createProductCard(product) {
    const div = document.createElement('div');
    div.className = 'card mb-3';
    
    div.innerHTML = `
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <img src="${product.image}" alt="${product.name}" class="img-fluid rounded" style="max-height: 100px;">
          </div>
          <div class="col-md-6">
            <h5 class="card-title">${product.name}</h5>
            <p class="card-text text-muted small">${product.description}</p>
            <div class="d-flex">
              <span class="badge bg-secondary me-2">${product.size}</span>
              <span class="badge bg-primary">${product.category}</span>
            </div>
          </div>
          <div class="col-md-3 text-end">
            <div class="mb-2">
              <span class="text-decoration-line-through text-muted me-2">₹${product.mrp.toFixed(2)}</span>
              <span class="fw-bold">₹${product.price.toFixed(2)}</span>
            </div>
            <div class="mb-2">
              <span class="badge bg-success">Stock: ${product.stock}</span>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${product.id}', ${JSON.stringify(product).replace(/"/g, '&quot;')})">
                <i class="bi bi-pencil"></i> Edit
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    return div;
  }

  function showAddProductModal() {
    document.getElementById('productForm').reset();
    document.getElementById('productForm').dataset.mode = 'add';
    const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
    modal.show();
  }

  function editProduct(productId, productData) {
    const product = typeof productData === 'string' ? JSON.parse(productData) : productData;
    
    document.getElementById('productName').value = product.name;
    document.getElementById('productSize').value = product.size;
    document.getElementById('productMRP').value = product.mrp;
    document.getElementById('productPrice').value = product.price;
    document.getElementById('productCategory').value = product.category;
    document.getElementById('productStock').value = product.stock;
    document.getElementById('productDescription').value = product.description;
    document.getElementById('productImage').value = product.image;
    
    document.getElementById('productForm').dataset.mode = 'edit';
    document.getElementById('productForm').dataset.productId = productId;
    
    const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
    modal.show();
  }

  async function saveProduct() {
    const form = document.getElementById('productForm');
    const mode = form.dataset.mode;
    const productId = form.dataset.productId;
    
    const productData = {
      name: document.getElementById('productName').value,
      size: document.getElementById('productSize').value,
      mrp: parseFloat(document.getElementById('productMRP').value),
      price: parseFloat(document.getElementById('productPrice').value),
      category: document.getElementById('productCategory').value,
      stock: parseInt(document.getElementById('productStock').value),
      description: document.getElementById('productDescription').value,
      image: document.getElementById('productImage').value,
      updatedAt: serverTimestamp()
    };
    
    try {
      if (mode === 'add') {
        productData.createdAt = serverTimestamp();
        await addDoc(collection(db, 'products'), productData);
        alert('Product added successfully!');
      } else {
        await updateDoc(doc(db, 'products', productId), productData);
        alert('Product updated successfully!');
      }
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
      modal.hide();
      loadProducts();
    } catch (error) {
      console.error('Error saving product:', error);
      alert('Failed to save product. Please try again.');
    }
  }

  async function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
      try {
        await deleteDoc(doc(db, 'products', productId));
        alert('Product deleted successfully!');
        loadProducts();
      } catch (error) {
        console.error('Error deleting product:', error);
        alert('Failed to delete product. Please try again.');
      }
    }
  }

  function filterProducts() {
    const searchTerm = document.getElementById('productSearch').value.toLowerCase();
    const productCards = document.querySelectorAll('#productsList .card');
    
    productCards.forEach(card => {
      const name = card.querySelector('.card-title').textContent.toLowerCase();
      const description = card.querySelector('.card-text').textContent.toLowerCase();
      
      if (name.includes(searchTerm) || description.includes(searchTerm)) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });
  }

  // Retailers functions
  async function loadRetailers() {
    try {
      const q = query(collection(db, 'retailers'), orderBy('createdAt', 'desc'));
      const querySnapshot = await getDocs(q);
      
      let totalRetailers = 0;
      let pendingRetailers = 0;
      let approvedRetailers = 0;
      
      const retailersList = document.getElementById('retailersList');
      retailersList.innerHTML = '';

      if (querySnapshot.empty) {
        retailersList.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-people" style="font-size: 3rem; color: #ccc;"></i>
            <h5 class="mt-3">No retailers yet</h5>
            <p class="text-muted">Retailer applications will appear here.</p>
          </div>
        `;
      } else {
        querySnapshot.forEach(doc => {
          const retailer = { id: doc.id, ...doc.data() };
          totalRetailers++;
          
          if (retailer.isApproved) {
            approvedRetailers++;
          } else {
            pendingRetailers++;
          }
          
          const retailerCard = createRetailerCard(retailer);
          retailersList.appendChild(retailerCard);
        });
      }

      // Update counters
      document.getElementById('retailersTotal').textContent = totalRetailers;
      document.getElementById('retailersPending').textContent = pendingRetailers;
      document.getElementById('retailersApproved').textContent = approvedRetailers;

    } catch (error) {
      console.error('Error loading retailers:', error);
    }
  }

  function createRetailerCard(retailer) {
    const div = document.createElement('div');
    div.className = 'card mb-3';
    
    const statusClass = retailer.isApproved ? 'status-approved' : 'status-pending';
    const statusText = retailer.isApproved ? 'Approved' : 'Pending Approval';
    
    div.innerHTML = `
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">${retailer.businessName}</h6>
        <span class="badge ${statusClass}">${statusText}</span>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p class="mb-2"><strong>Owner:</strong> ${retailer.ownerName}</p>
            <p class="mb-2"><strong>Email:</strong> ${retailer.email}</p>
            <p class="mb-2"><strong>Phone:</strong> ${retailer.phone}</p>
            <p class="mb-2"><strong>GST:</strong> ${retailer.gst || 'Not provided'}</p>
          </div>
          <div class="col-md-6">
            <p class="mb-2"><strong>Address:</strong></p>
            <p class="text-muted small">${retailer.address}</p>
            <p class="mb-2"><strong>Applied:</strong> ${retailer.createdAt?.toDate().toLocaleDateString() || 'N/A'}</p>
          </div>
        </div>
        ${!retailer.isApproved ? `
          <div class="mt-3">
            <button class="btn btn-success me-2" onclick="approveRetailer('${retailer.id}')">
              <i class="bi bi-check-circle"></i> Approve
            </button>
            <button class="btn btn-danger" onclick="rejectRetailer('${retailer.id}')">
              <i class="bi bi-x-circle"></i> Reject
            </button>
          </div>
        ` : ''}
      </div>
    `;
    
    return div;
  }

  async function approveRetailer(retailerId) {
    if (confirm('Are you sure you want to approve this retailer?')) {
      try {
        await updateDoc(doc(db, 'retailers', retailerId), {
          isApproved: true,
          approvedAt: serverTimestamp()
        });
        alert('Retailer approved successfully!');
        loadRetailers();
        loadDashboard();
      } catch (error) {
        console.error('Error approving retailer:', error);
        alert('Failed to approve retailer. Please try again.');
      }
    }
  }

  async function rejectRetailer(retailerId) {
    if (confirm('Are you sure you want to reject this retailer? This action cannot be undone.')) {
      try {
        await updateDoc(doc(db, 'retailers', retailerId), {
          isApproved: false,
          rejectedAt: serverTimestamp()
        });
        alert('Retailer rejected.');
        loadRetailers();
        loadDashboard();
      } catch (error) {
        console.error('Error rejecting retailer:', error);
        alert('Failed to reject retailer. Please try again.');
      }
    }
  }

  // Expose functions to global scope
  window.login = login;
  window.logout = logout;
  window.confirmOrder = confirmOrder;
  window.cancelOrder = cancelOrder;
  window.markDelivered = markDelivered;
  window.viewOrderDetails = viewOrderDetails;
  window.showAddProductModal = showAddProductModal;
  window.saveProduct = saveProduct;
  window.editProduct = editProduct;
  window.deleteProduct = deleteProduct;
  window.filterProducts = filterProducts;
  window.approveRetailer = approveRetailer;
  window.rejectRetailer = rejectRetailer;

  // Initialize app when page loads
  window.addEventListener('load', initApp);
</script>
</body>
</html>
